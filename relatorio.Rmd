---
title: "Análise de Questionários do Projeto 'Meninas na Computação'"
output:
  html_notebook: 
    code_folding: hide
  html_document: default
---
```{r, include=FALSE}
rm(list = ls())
options("scipen"=100, "digits"=2)

library(readxl)
# library(readr)
library(arules)
library(ggplot2)
library(reshape2)
library(gridExtra)
library(stringr)
library(knitr)
library(arules)
```

Este estudo é uma análise estatística sobre o projeto [Meninas na Computação](http://meninas.cic.unb.br/), coordenado pela professora Dra. Maristela Terto e Holanda et al. 

```{r}
respostas <- read_excel("../dados/raw.xlsx", sheet = "unificado", na = "")

respostas$Q1 <- NULL
respostas$Q2 <- NULL
respostas$Serie <- stringr::str_trim(respostas$Serie, side = "both")
respostas <- as.data.frame(lapply(respostas, as.factor))
respostas <- respostas[, c(5, 1, 2, 3, 4, 6:ncol(respostas))]
```

Durante os anos de 2011 a 2014, foram entrevistados `r nrow(respostas)` alunos do nível fundamental, médio e superior, sobre o curso superior que pretendiam seguir. 

O questionário possui 14 questões que foram desmembradas em 36 variáveis.

O primeiro passo do estudo foi recuperar as respostas dos questionários. 

O segundo passo envolveu a preparação dos dados. Em primeiro lugar, os questionários foram unificados em uma única tabela, a fim de facilitar a manipulação.

Como o estudo consiste em identificar as motivações das alunas entrevistadas em seguir ou não uma carreira em Ciência da Computação, foram retirados os `r nrow(respostas[respostas$Sexo == 'M',])` entrevistados de sexo masculino.

```{r}
respostas <- subset(respostas, respostas$Sexo == "F")
respostas$Sexo <- NULL
```

São encontradas as seguintes distribuições de série na amostra:

```{r}
series <- aggregate(x = list(Quantidade = respostas$Serie), by = list(Ano = respostas$Ano, Serie = respostas$Serie), FUN=length)

por_ano <- aggregate(x = list(Total = respostas$Serie), by = list(Ano = respostas$Ano), FUN=length)

series <- merge(series, por_ano)

series$Percentual <- series$Quantidade * 100 / series$Total

p = ggplot(data = series, aes(x = "", y = Percentual, fill = Serie))  
p = p + geom_bar(width = 1, stat = "identity")
p = p + facet_grid(facets = . ~ Ano)
p = p + coord_polar(theta = "y", start = 0) 
p = p + scale_x_discrete()
p = p + xlab("") + ylab("") + labs(fill="Ano") 
p = p + ggtitle("Percentual de Entrevistadas por Série em cada Ano")
p
```

As alunas responderam da seguinte forma sobre a área que gostariam de cursar:

```{r}
cursos <- aggregate(x = list(Quantidade = respostas$Fara_Curso_Superior), by = list(Ano = respostas$Ano, Fara_Curso_Superior = respostas$Fara_Curso_Superior), FUN=length)

por_ano <- aggregate(x = list(Total = respostas$Fara_Curso_Superior), by = list(Ano = respostas$Ano), FUN=length)

cursos <- merge(cursos, por_ano)

cursos$Percentual <- cursos$Quantidade * 100 / cursos$Total

p = ggplot(data = cursos, aes(x = "", y = Percentual, fill = Fara_Curso_Superior))  
p = p + geom_bar(width = 1, stat = "identity")
p = p + facet_grid(facets = . ~ Ano)
p = p + coord_polar(theta = "y", start = 0) 
p = p + scale_x_discrete()
p = p + xlab("") + ylab("") + labs(fill="Ano") 
p = p + ggtitle("Percentual de Entrevistadas por Área de Interesse")
p
```

Podemos observar que os percentuais permanecem ao longo dos anos, sendo a preferência por Ciências Biológicas e de Saúde em torno de `r round(cursos$Percentual[cursos$Ano == 2011 & cursos$Fara_Curso_Superior == 'Biologicas e Saude'])`\%, para Humanas cerca de `r round(cursos$Percentual[cursos$Ano == 2011 & cursos$Fara_Curso_Superior == 'Humanas'])`\% e para Exatas próximo a `r round(cursos$Percentual[cursos$Ano == 2011 & cursos$Fara_Curso_Superior == 'Exatas'])`\%.

A opinião das alunas sobre o cursar Ciência da Computação é representada nos gráficos a seguir:

```{r}
comp <- aggregate(x = list(Quantidade = respostas$Fara_Computacao), by = list(Ano = respostas$Ano, Fara_Computacao = respostas$Fara_Computacao), FUN=length)

por_ano <- aggregate(x = list(Total = respostas$Fara_Computacao), by = list(Ano = respostas$Ano), FUN=length)

comp <- merge(comp, por_ano)

comp$Percentual <- comp$Quantidade * 100 / comp$Total

p = ggplot(data = comp, aes(x = "", y = Percentual, fill = Fara_Computacao))  
p = p + geom_bar(width = 1, stat = "identity")
p = p + facet_grid(facets = . ~ Ano)
p = p + coord_polar(theta = "y", start = 0) 
p = p + scale_x_discrete()
p = p + xlab("") + ylab("") + labs(fill="Ano") 
p = p + ggtitle("Percentual de Entrevistadas por Interesse em Computação")
p
```

Será realizada a seguir uma análise de variância, no intuito de identificar se há algum dos atributos coletados no questionário indique alguma variação na média de candidatas que optam por computação, isto é, se o atributo **Fara_Computacao** muda dependendo de outros atributos. 

Para que seja feita a análise de variância, a amostra deve atender certas pressuposições básicas:
1) os erros são variáveis aleatórias independentes;
2) a variância é constante;
3) a distribuição dos erros é normal ou aproximadamente normal.


Como exemplo, será efetuada isoladamente a análise de variância do atributo **Fara_Computacao** em relação ao atributo **Ano**, com as respostas **Sim**, **Nao** e **Nao sei ainda** como blocos de estudo e os anos como o tratamentos. A variável observada é a quantidade de respondentes para cada resposta, em cada ano.

```{r}
Ano <- aggregate(x = list(QT = respostas$Ano), by = list(Bloco = respostas$Ano, Tratamento = respostas$Fara_Computacao), FUN=length)
knit_print(Ano)

fit <- lm(QT ~ Tratamento + Bloco, data = Ano)
knit_print(anova(fit))
par(mfrow=c(2,2))
plot(fit)
knit_print(TukeyHSD(fit))
```

A partir do p-valor do tratamento **Ano** (Pr(>F)) abaixo de 5%, há evidências de uma diferença na quantidade de alunas que optam por computação devido à passagem do tempo. O problema é que a quantidade de entrevistados no ano de 2011 é muito superior à dos outros anos, o que claramente causou a diferença nas médias. Com isso, a análise acima ficou prejudicada, não podendo ser considerada correta.

```{r}
tam_amostra <- 400
```


Para evitar que características especifícas das coletas em diferentes anos prejudiquem a análise, foram selecionadas aleatoriamente `r tam_amostra` amostras de cada ano. Apesar da redução, o novo tamanho da amostra irá prover um nível de confiança de 95%, com margem de erro menor que 5%.

```{r}
niveis <- levels(respostas$Ano)
amostra_anova <- NULL
set.seed(2017)
for (i in 1:length(niveis)) {
 temp <- respostas[respostas$Ano == niveis[i],]
 rownames(temp) <- 1:nrow(temp)
 temp <- temp[sample(nrow(temp), tam_amostra), ]
 if (is.null(amostra_anova)) {
   amostra_anova <- temp
 } else {
   amostra_anova <- rbind(amostra_anova, temp)
 }
}
rm("temp")
```

A seguir serão apresentadas as análises de variância dos atributos coletados nas entrevistas.

```{r}
par(mfrow=c(2,2))
for (i in 2:ncol(amostra_anova)) {
  temp <- aggregate(list(QT = amostra_anova[, i]), by = list(Bloco = amostra_anova[, i], Tratamento = amostra_anova$Fara_Computacao), FUN=length)

  # complementar temp com dominios zerados
  temp2 <- expand.grid(Tratamento = levels(amostra_anova$Fara_Computacao), Bloco = levels(amostra_anova[, i]))
  temp <- merge(temp, temp2, all.y = TRUE)
  temp$QT[is.na(temp$QT)] <- 0
  
  nome <- colnames(amostra_anova)[i]
  cat(paste("\nBloco:", nome, "\n"))  
  cat("\n")
  knit_print(temp)
  cat("\n")
  
  knit_print(aggregate(x = list(Media = temp$QT), by = list(Tratamento = temp$Tratamento), FUN=mean))
  cat("\n")
  
  fit <- lm(QT ~ Tratamento + Bloco, data = temp)
  knit_print(anova(fit))
  
  plot(fit)
  
  knit_print(TukeyHSD(fit))
  
  assign(nome, temp)
}

```




O próximo passo é identificar se há combinações de atributos que expliquem essa opção. Para isso será utilizado o algoritmo Apriori de mineração de regras de associação.

```{r}
# regras = apriori(data = respostas)
# regras = apriori(data = respostas, parameter = list(minlen=2, supp=0.1, conf=0.8, maxtime=300), appearance = list(rhs = c("Fara_Computacao=Sim", "Fara_Computacao=Nao", "Fara_Computacao=Nao sei ainda"), default="lhs"))

# regras.ordem <- sort(regras, by="lift")
# write(regras.ordem, file="../dados/regras.txt")
```

